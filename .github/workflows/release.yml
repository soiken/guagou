name: Update Release with Latest File

on:
  push:
    branches:
      - main

jobs:
  update-release:
    runs-on: ubuntu-latest
    steps:
    - name: Set up Git
      run: |
        git config user.email "neilkan8@gmail.com"
        git config user.name "Nekios"
      # Continue on error since the configuration might already be set up.

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Latest File
      run: |
        wget -O latest_file.mpackage https://github.com/soiken/guagou/raw/main/build/Nekios.mpackage
      continue-on-error: true

    - name: Create Tag
      id: create_tag
      run: git tag -a v1 -m "Version 1" && git push origin v1
      if: success()

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          latest_file.mpackage
        token: ${{ secrets.GH_PAT }}

    - name: Delete Previous Release
      run: |
        release_id=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.id')
        if [ ! -z "$release_id" ]; then
          curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases/$release_id
        fi
